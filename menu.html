<!doctype html>
<html lang="en" class="no-js">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Merriweather:400,700|Merriweather+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="stylesheets/reset.css">
    <!-- CSS reset -->
    <link rel="stylesheet" href="stylesheets/style.css">
    <!-- Resource style -->
    <title>Real Bomb</title>
</head>

<body class="extinguisher-transition">
    <audio id="sound-file" preload="auto">
        <source src="sounds/button_bomb.mp3" type="audio/mp3">
    </audio>
    <main class="cd-main-content">
        <div class="center">
            <h1>Real Bomb!!</h1>
            <a href="#modal-1" class="cd-btn cd-modal-trigger">Game Start</a>
        </div>
    </main>
    <!-- .cd-main-content -->
    <div class="cd-modal" id="modal-1">
        <div class="modal-content">
            <h2>Mode Select</h2>
            <div class="mode">
                <center>
                    <a ref = "/defender" href="javascript:void(0);" class="cd-btn">
                        Defender
                    </a>
				<div class="defender_space"></div>
                </center>
            </div>
            <div class="mode">
                <center>
                    <a ref = "/insert" href="javascript:void(0);" class="cd-btn">
                        Attacker
                    </a>
                    <div class="attacker_space"></div>
                </center>
            </div>
        </div>
        <!-- .modal-content -->
        <a href="#0" class="modal-close">Close</a>
    </div>
    <!-- .cd-modal -->
    <div class="cd-transition-layer" data-frame="25">
        <div class="bg-layer"></div>
    </div>
    <!-- .cd-transition-layer -->
    <script src="javascripts/modernizr.js"></script>
    <!-- Modernizr -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script>
    if (!window.jQuery) document.write('<script src="javascripts/jquery-2.2.1-min.js"><\/script>');
    </script>
    <script src="javascripts/main.js"></script>
    <!-- Resource jQuery -->
    <script>
    function receive() {
        var hostUrl = '/receive';
        $.ajax({
            url: hostUrl,
            type: "post",
            dataType: "json",
            success: function(res) {
                console.log(res);
                display(res);
            },
            error: function(res) {
                console.log("ERROR");
            }
        });
    }

    var players = [];
    var player_limit = 10;
    var def_exist = false;

    function display(data) {
        for (var i = 0; i < data.length; i++) {
            var name = data[i].name;

            if (players.indexOf(name) == -1) {
                // nameがplayersに存在しない場合
                players.push(name);

                var dom1 = '<p>player number<br>' + players.length + '/10</p>';
                $(".mode .attacker_space").empty();
                $(".mode .attacker_space").append(dom1);

                if(def_exist){
                	var dom2 = '<p>player number<br>1/1</p>';
           		} else {
           			var dom2 = '<p>player number<br>0/1</p>';
           		}
           		$(".mode .defender_space").empty();
                $(".mode .defender_space").append(dom2);

            }
        }
    }

    function is_def_exist() {
        var hostUrl = '/is_def_exist';
        $.ajax({
            url: hostUrl,
            type: "post",
            dataType: "json",
            success: function(res) {
                console.log(res);
                def_exist = res.def_exist;
                invalidate_button();
            },
            error: function(res) {
                console.log("ERROR");
            }
        });
    }

    function invalidate_button() {
        if (def_exist) {
        	console.log(def_exist);
            $('a.defender').click(function() {
                return false;
            });
            $(".defender").css({
                "background": "#BDBDBD",
            });
        }

        if (players.length > player_limit) {
            $('a.attacker').click(function() {
                return false;
            });
            $(".attacker").css({
                "background": "#BDBDBD",
            });
        }
    }

    window.onload = function(){
    	is_def_exist();
    	receive();
    	setInterval(receive.bind(this), 5000);
    	setInterval(is_def_exist.bind(this), 5000);

	}

    </script>
</body>

</html>
