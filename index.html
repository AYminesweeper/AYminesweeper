 <!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>document</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
    #map {
      width: 60vw;
      height: 80vh;
    }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <button id="update">送信(update)</button>
    <!-- お名前：<input type="text" id="cojtid" placeholder="入れたら自動でJSが認識します" /> -->
    <form name="input_name">
    player name：<input type="text" name="p_name" value=""><br>
    <input type="button" id="insert" value="決定!" ><br>
    </form>

    <script src="https://code.jquery.com/jquery-2.2.4.min.js" charset="utf-8"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCiT4RlnaJjLrUQemtR-OsUHXVg_iJ6iLI"></script>
    <script type="text/javascript">


    //setting
    var cell = 10;  //マスの数
    var high = 36.11204;  //左上点の緯度 baseY
    var low = 36.109698;  //右下点の緯度
    var left = 140.09901;  //左上点の経度 baseX
    var right = 140.102199;  //右下点の経度
    var latlng = [36.109899, 140.10176]; //爆弾設置


    var length = cell*2+2;
    var points1 = new Array(length);
    var points1_lat = new Array(points1.length);
    points1_lat[0] = high;
    var points1_lng = new Array(points1.length);
    var n = low;
    for(var i = 1; i < points1.length; i+=2) {
      points1_lat[i] = n;
      points1_lat[i+1] = n;
      if(n == high){
        n = low;
      } else {
        n = high;
      }
    }

    var space1 = (right-left)/cell;
    var n = left;
    for(var i = 0; i < points1.length; i+=2) {
      points1_lng[i] = n;
      points1_lng[i+1] = n;
      n += space1;
    }

    var points2 = new Array(length);
    var points2_lat = new Array(length);
    var points2_lng = new Array(length);
    points2_lng[0] = left;

    var m = right;
    for(var i = 1; i < length; i += 2) {
      points2_lng[i] = m;
      points2_lng[i+1] = m;
      if (m == left) {
        m = right;
      } else {
        m = left
      }
    }

    var space2 = (high-low)/cell;
    var m = high;
    for (var i = 0; i < length; i += 2) {
      points2_lat[i] = m;
      points2_lat[i+1] = m;
      m -= space2;
    }

    var lat_array = new Array(cell);
    var lng_array = new Array(cell);
    lat_array[0] = high;
    lng_array[0] = left;
    var index = 1;
    for (var i = 3; i < length; i +=4) {
      lat_array[index] = points2_lat[i];
      lat_array[index+1] = points2_lat[i+1];
      lng_array[index] = points1_lng[i];
      lng_array[index+1] = points1_lng[i+1];

      index += 2;
    }


      var map;
      var send_pos;
      function initMap() {
          // 緯度・経度を変数に格納
          //var mapLatLng = new google.maps.LatLng(36.109651, 140.101704);
          var centerposition = new google.maps.LatLng(36.110732, 140.100619);

          // マップオプションを変数に格納
          var mapOptions = {
              zoom : 18,
              center : centerposition,  // 中心は現在地の緯度・経度
              scrollwheel : false,
              //draggable : false,
              rotateControl : true,
          };
          // マップオブジェクト作成
          map = new google.maps.Map(
              document.getElementById("map"), // マップを表示する要素
              mapOptions         // マップオプション
          );
          //markPos(pos_data);
          startWatchPosition();








          for(i = 0; i < points1.length; i++) {
            var lat = points1_lat[i];
            var lng = points1_lng[i];
            points1[i] = new google.maps.LatLng(lat, lng);
          }

          /*var points1 = [
            new google.maps.LatLng(36.109900, 140.101350),
            new google.maps.LatLng(36.109427, 140.101350),
            new google.maps.LatLng(36.109427, 140.10143675),
            new google.maps.LatLng(36.109900, 140.10143675),
            new google.maps.LatLng(36.109900, 140.10152350),
            new google.maps.LatLng(36.109427, 140.10152350),
            new google.maps.LatLng(36.109427, 140.10161025),
            new google.maps.LatLng(36.109900, 140.10161025),
            new google.maps.LatLng(36.109900, 140.10169700),
            new google.maps.LatLng(36.109427, 140.10169700),
            new google.maps.LatLng(36.109427, 140.10178375),
            new google.maps.LatLng(36.109900, 140.10178375),
            new google.maps.LatLng(36.109900, 140.10187050),
            new google.maps.LatLng(36.109427, 140.10187050),
            new google.maps.LatLng(36.109427, 140.10195725),
            new google.maps.LatLng(36.109900, 140.10195725),
            new google.maps.LatLng(36.109900, 140.10204400),
            new google.maps.LatLng(36.109427, 140.10204400)
          ]*/



          for (var i = 0; i < length; i++) {
            points2[i] = new google.maps.LatLng(points2_lat[i], points2_lng[i]);
          }

          //console.log(space1);
          //console.log(space2);

          /*var points2 = [
            new google.maps.LatLng(36.109900, 140.101350),
            new google.maps.LatLng(36.109900, 140.102044),
            new google.maps.LatLng(36.109840875, 140.102044),
            new google.maps.LatLng(36.109840875, 140.101350),
            new google.maps.LatLng(36.10978175, 140.101350),
            new google.maps.LatLng(36.10978175, 140.102044),
            new google.maps.LatLng(36.109722625, 140.102044),
            new google.maps.LatLng(36.109722625, 140.101350),
            new google.maps.LatLng(36.1096635, 140.101350),
            new google.maps.LatLng(36.1096635, 140.102044),
            new google.maps.LatLng(36.109604375, 140.102044),
            new google.maps.LatLng(36.109604375, 140.101350),
            new google.maps.LatLng(36.10954525, 140.101350),
            new google.maps.LatLng(36.10954525, 140.102044),
            new google.maps.LatLng(36.109486125, 140.102044),
            new google.maps.LatLng(36.109486125, 140.101350),
            new google.maps.LatLng(36.109427, 140.101350),
            new google.maps.LatLng(36.109427, 140.102044)
          ]*/

          var PolylineOptions1 = {
            map: map,
            path: points1,
            strokeWeight: 5,
            strokeColor: "#0000ff",
            strokeOpacity: "0.5"
          };

          var PolylineOptions2 = {
            map: map,
            path: points2,
            strokeWeight: 5,
            strokeColor: "#0000ff",
            strokeOpacity: "0.5"
          };

          var poly1 = new google.maps.Polyline(PolylineOptions1);
          poly1.setMap(map);

          var poly2 = new google.maps.Polyline(PolylineOptions2);
          poly2.setMap(map);

      }


      function setBom(latlng) {
        var BomPosition = latlng;
        var position = new Array();
        for (var i = 0; i < cell; i++) {
          position[i] = new Array();
          for (var j = 0; j < cell; j++) {
            position[i][j] = 0;
          }
        }
        //console.log(BomPosition[0]);

        for (var i = 0; i < cell; i++) {
          if (lng_array[i] <= BomPosition[1] && BomPosition[1] < lng_array[i+1]) {
            for (var j = 0; j < cell; j++) {
              if (BomPosition[0] <= lat_array[j] && lat_array[j+1] < BomPosition[0]) {
                position[j][i] = 1;
                return position;
              }
            }
          } //else {
            //console.log(err);
          //}
        }

        //setBom();
        //console.log(position);

      }


      $( function insert() {
        console.log($('#insert'));
            $( '#insert' ) .click(
              function() {
                var hostUrl= '/insert';
                var name = document.input_name.p_name.value;
                $.ajax({
                  url: hostUrl,
                  type:'POST',
                  dataType: 'json',
                  data :{"name" : name, "pos" : {"lat":10.00001, "long":10.00001}},
                  //timeout:10000,
                }).done(function(data) {
                  console.log("ok");
                  console.log(data);
                }).fail(function(XMLHttpRequest, textStatus, errorThrown) {
                  alert("error");
                })
              });
          } );

      function receive(){
        var hostUrl= '/receive';
        $.ajax({
          // url: "http://192.168.17.140:8887/data.json",
          // url: "https://pullpulldondon.github.io/pos.json",
          //url: "https://polar-bastion-81724.herokuapp.com/receivePosition",
          url: hostUrl,
          type: "post",
          dataType: "json",

          success: function(res){
            console.log(res);
            markPos(res);
          },
          error: function(res){
            console.log("ERROR");
          }
        });
      }

      function sendPosData(){
        var hostUrl= '/update';
        //if(name === "") return;
        //pos.name = name;
        $.ajax({
          // url: "/",
          url: hostUrl,
          type: "post",
          dataType: "json",
          data: send_pos ,

          success: function(res){
            console.log("sendPosData: Success");
            console.log(res);
          },
          error: function(res){
            console.log("sendPosData: Error");
            console.log(res);
          }
        });
      }
      // var pos = {"lat":11, "long":12};
      // sendPosData(pos);

  //     $( function() {
    //  $( '#update' ) .click(
    //    function sendPosData(pos) {
    //      var hostUrl= '/update';
    //      $.ajax({
    //        url: hostUrl,
    //        type:'post',
    //        dataType: 'json',
    //        data :pos,
    //        //timeout:10000,
    //      }).done(function(data) {
    //        console.log("ok");
    //        console.log(data);
    //      }).fail(function(XMLHttpRequest, textStatus, errorThrown) {
    //        alert("error");
    //      })
    //    });
    // } );

    $( function() {
      $( '#update' ).click(sendPosData)
    });


    /* $( function() {
      $( '#ajax-button' ) .click(
        function sendPosData(pos) {
          var hostUrl= '/insert';
          $.ajax({
            url: hostUrl,
            type:'POST',
            dataType: "text",
            //data : {"name" : "person1", "pos" : {"lat":10.00001, "long":10.00001}},
            data : JSON.stringify(pos),
            //timeout:10000,
          }).done(function(data) {
          console.log("ok");
            console.log(data);
          }).fail(function(XMLHttpRequest, textStatus, errorThrown) {
            alert("error");
          })
        });
    } );*/


      function markPos(pos_data){
          for(var arrCount = 0; arrCount < pos_data.length; arrCount++){
              var pos = new google.maps.LatLng(pos_data[arrCount].lat, pos_data[arrCount].long);
              var name = pos_data[arrCount].name;
              var icon = new google.maps.MarkerImage('http://www.yoshikiminatoya.com/sample/googlemap/03/images/ico_map.png',
                new google.maps.Size(73,51),
                new google.maps.Point(0,0),
                new google.maps.Point(19,51)
              );
              var marker = new google.maps.Marker({
                  position: pos,
                  map: map,
                  title: name,
                  icon: icon
              });
              var info = new google.maps.InfoWindow({
                  content: name,
                  disableAutoPan: true
              }).open(marker.getMap(), marker);
          }
      }

      var infoWindow = new google.maps.InfoWindow;
      /* */
      function startWatchPosition(){
        //Try HTML5 geolocation.
        if (navigator.geolocation) {
          //get a current position
          navigator.geolocation.watchPosition(onWatchPosition, function(err) {
            console.log('hell');
            console.log(err);
            handleLocationError(true, infoWindow, map.getCenter());
          });
        } else {
          //Browser doesnt support Geolocation.
          handleLocationError(false, infoWindow, map.getCenter());
        }
      }

      function onWatchPosition(position){
        //console.log(sucess);
        //create a position object.
        var pos = {
          lat: position.coords.latitude,
          long: position.coords.longitude
        };

        console.log(pos.lat);
        console.log(pos.long);

        /*infoWindow.setPosition(pos);
        infoWindow.setContent('Location found.');
        map.setCenter(pos);*/

        //アイコンの表示設定
        // var icon = new google.maps.MarkerImage('img/hand-finger-64px.png',
        //   new google.maps.Size(64, 64),
        //   new google.maps.Point(0, 0)
        // );

        send_pos = {"name" : "person1", "pos" : {"lat":pos.lat, "long":pos.long}};
        console.log(send_pos);
        sendPosData(send_pos);

        var markerOptions = {
          position: pos,
          map: map
        };

        //アイコンを表示させる記述
        var marker = new google.maps.Marker(markerOptions);
      }
      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        console.log('failed')
        infoWindow.setPosition(pos) ;
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.':
                              'Error: Your browser doesn\'t support geolocation');
      }

      initMap();
      var position = setBom(latlng);
      console.log(position);  //爆弾の位置を配列にて表示
      setInterval(receive.bind(this), 5000);
      setInterval(sendPosData.bind(this), 5000);
    </script>
  </body>
</html>
