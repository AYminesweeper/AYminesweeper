<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>document</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
    #map {
      width: 100vw;
      height: 100vh;
      margin: 0 auto;
      transform: rotate(28deg);
    }
    </style>
  </head>
  <body>
    <!-- お名前：<input type="text" id="cojtid" placeholder="入れたら自動でJSが認識します" /> -->
    <!--<select name="" id="select">
      <option value="" selected>選択してください</option>
      <option value="sw101">sw101</option>
      <option value="sw102">sw102</option>
      <option value="sw103">sw103</option>
      <option value="sw104">sw104</option>
      <option value="sw105">sw105</option>
      <option value="sw106">sw106</option>
      <option value="sw107">sw107</option>
      <option value="sw108">sw108</option>
      <option value="sw109">sw109</option>
      <option value="sw110">sw110</option>
      <option value="sw111">sw111</option>
      <option value="sw112">sw112</option>
      <option value="sw113">sw113</option>
      <option value="sw007">sw007</option>
      <option value="sw100">sw100</option>
    </select>-->
    <div id="map">

    </div>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js" charset="utf-8"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCiT4RlnaJjLrUQemtR-OsUHXVg_iJ6iLI"></script>
    <script type="text/javascript">
      //var pos_data = {"students": [
      //        {"name":"?", "pos":{"lat": 36.400000, "long": 140.500000}}
      //   ]};

      /*var name = "";
      $("#select").on("change", function(){
        var n = $(this).val();
        console.log(n);
        if(n !== ""){
          name = n;
          $(this).css("display", "none");
        }
      });*/

      var map;
      function initMap() {
          // 緯度・経度を変数に格納
          var mapLatLng = new google.maps.LatLng(36.109651, 140.101704);
          var centerposition = new google.maps.LatLng(36.109651, 140.101704);
          // マップオプションを変数に格納
          var mapOptions = {
              zoom : 20,
              center : centerposition,  // 中心は現在地の緯度・経度
              scrollwheel : false,
              draggable : false,
              rotateControl : true,
          };
          // マップオブジェクト作成
          map = new google.maps.Map(
              document.getElementById("map"), // マップを表示する要素
              mapOptions         // マップオプション
          );
          // markPos(pos_data);
          startWatchPosition();
      }

      function receive(){
        $.ajax({
          // url: "http://192.168.17.140:8887/data.json",
          // url: "https://pullpulldondon.github.io/pos.json",
          url: "https://polar-bastion-81724.herokuapp.com/receivePosition",
          type: "post",
          dataType: "json",
          success: function(res){
            markPos(JSON.parse(res));
          },
          error: function(res){
            console.log("ERROR");
          }
        });
      }

      function sendPosData(pos){
        if(name === "") return;
        pos.name = name;
        $.ajax({
          // url: "/",
          url: "https://polar-bastion-81724.herokuapp.com/sendPosition",
          type: "post",
          //dataType: "json",
          // data: pos,
          data: JSON.stringify(pos),
          dataType: "text",
          success: function(res){
            console.log("sendPosData: Success");
            console.log(res);
          },
          error: function(res){
            console.log("sendPosData: Error");
            console.log(res);
          }
        });
      }
      // var pos = {"lat":11, "long":12};
      // sendPosData(pos);

      function markPos(pos_data){
          for(var arrCount = 0; arrCount < pos_data.students.length; arrCount++){
              var pos = new google.maps.LatLng(pos_data.students[arrCount].pos.lat, pos_data.students[arrCount].pos.long);
              var name = pos_data.students[arrCount].name;
              var icon = new google.maps.MarkerImage('http://www.yoshikiminatoya.com/sample/googlemap/03/images/ico_map.png',
                new google.maps.Size(73,51),
                new google.maps.Point(0,0),
                new google.maps.Point(19,51)
              );
              var marker = new google.maps.Marker({
                  position: pos,
                  map: map,
                  title: name,
                  icon: icon
              });
              var info = new google.maps.InfoWindow({
                  content: name,
                  disableAutoPan: true
              }).open(marker.getMap(), marker);
          }
      }

      var infoWindow = new google.maps.InfoWindow;
      /* */
      function startWatchPosition(){
        //Try HTML5 geolocation.
        if (navigator.geolocation) {
          //get a current position
          navigator.geolocation.watchPosition(onWatchPosition, function(err) {
            console.log('hell');
            console.log(err);
            handleLocationError(true, infoWindow, map.getCenter());
          });
        } else {
          //Browser doesnt support Geolocation.
          handleLocationError(false, infoWindow, map.getCenter());
        }
      }

      function onWatchPosition(position){
        //console.log(sucess);
        //create a position object.
        var pos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };

        console.log(pos.lat);
        console.log(pos.lng);

        /*infoWindow.setPosition(pos);
        infoWindow.setContent('Location found.');
        map.setCenter(pos);*/

        //アイコンの表示設定
        // var icon = new google.maps.MarkerImage('img/hand-finger-64px.png',
        //   new google.maps.Size(64, 64),
        //   new google.maps.Point(0, 0)
        // );

        var send_pos = {"lat":pos.lat, "long":pos.lng};
        sendPosData(send_pos);

        var markerOptions = {
          position: pos,
          map: map
        };

        //アイコンを表示させる記述
        var marker = new google.maps.Marker(markerOptions);
      }
      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        console.log('failed')
        infoWindow.setPosition(pos) ;
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.':
                              'Error: Your browser doesn\'t support geolocation');
      }

      initMap();
      setInterval(receive.bind(this), 5000);
    </script>
  </body>
</html>
